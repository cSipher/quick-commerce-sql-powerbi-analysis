-- Rank companies by AOV
SELECT
    Company,
    AVG(Order_Value) AS avg_order_value,
    RANK() OVER (ORDER BY AVG(Order_Value) DESC) AS rank_aov
FROM qc_orders_clean
GROUP BY Company;

-- Top company per city
WITH city_company_revenue AS (
    SELECT
        City,
        Company,
        SUM(Order_Value) AS revenue
    FROM qc_orders_clean
    GROUP BY City, Company
)
SELECT *
FROM (
    SELECT
        City,
        Company,
        revenue,
        RANK() OVER (PARTITION BY City ORDER BY revenue DESC) AS city_rank
    FROM city_company_revenue
) t
WHERE city_rank = 1;

-- Cumulative revenue contribution
WITH company_revenue AS (
    SELECT
        Company,
        SUM(Order_Value) AS revenue
    FROM qc_orders_clean
    GROUP BY Company
)
SELECT
    Company,
    revenue,
    ROUND(
        100.0 * SUM(revenue) OVER (ORDER BY revenue DESC)
        / SUM(revenue) OVER (), 2
    ) AS cumulative_revenue_pct
FROM company_revenue
ORDER BY revenue DESC;